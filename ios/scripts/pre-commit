#!/bin/bash
#
# Pre-commit hook for PacerID
# Runs SwiftFormat and SwiftLint on staged Swift files
#
# To install: Run `make install-hooks` or `./scripts/install-hooks.sh`

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SWIFTFORMAT_PATH=$(which swiftformat)
SWIFTLINT_PATH=$(which swiftlint)

echo -e "${BLUE}Running pre-commit checks...${NC}"

# Check if tools are installed
if [ ! -x "$SWIFTFORMAT_PATH" ]; then
    echo -e "${RED}Error: SwiftFormat not found!${NC}"
    echo "Install with: brew install swiftformat"
    exit 1
fi

if [ ! -x "$SWIFTLINT_PATH" ]; then
    echo -e "${RED}Error: SwiftLint not found!${NC}"
    echo "Install with: brew install swiftlint"
    exit 1
fi

# Get staged Swift files
SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.swift$')

if [ -z "$SWIFT_FILES" ]; then
    echo -e "${GREEN}No Swift files to check${NC}"
    exit 0
fi

echo -e "${BLUE}Checking ${#SWIFT_FILES[@]} Swift file(s)...${NC}"

# Format staged files
echo -e "${BLUE}Running SwiftFormat...${NC}"
for file in $SWIFT_FILES; do
    if [ -f "$file" ]; then
        echo "  Formatting: $file"
        $SWIFTFORMAT_PATH "$file" --config .swiftformat

        # Re-stage formatted file
        git add "$file"
    fi
done
echo -e "${GREEN}✓ SwiftFormat complete${NC}"

# Lint staged files
echo -e "${BLUE}Running SwiftLint...${NC}"
LINT_ERRORS=0

for file in $SWIFT_FILES; do
    if [ -f "$file" ]; then
        $SWIFTLINT_PATH lint "$file" --quiet --config .swiftlint.yml
        if [ $? -ne 0 ]; then
            LINT_ERRORS=1
        fi
    fi
done

if [ $LINT_ERRORS -eq 1 ]; then
    echo -e "${RED}✗ SwiftLint found issues!${NC}"
    echo -e "${YELLOW}Fix the issues above or use 'git commit --no-verify' to skip checks${NC}"
    exit 1
fi

echo -e "${GREEN}✓ SwiftLint passed${NC}"
echo -e "${GREEN}✓ All checks passed!${NC}"

exit 0
